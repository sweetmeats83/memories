{# Only extend base when it's a full page #}{% if not partial %}{% extends "base.html" %}{% endif %}{% block content %}{# move your constants INSIDE the block so "extends" stays first #}{% set ORANGE = "#C65D31" %}{% set ORANGE_HOVER = "#E07A3F" %}{% set BORDER = "#E7E5E4" %}<style>  .spinner { position:absolute; inset:0; display:grid; place-items:center; background:rgba(255,255,255,.6); }  .spinner::after { content:""; width:20px; height:20px; border-radius:50%;    border:3px solid #e5e7eb; border-top-color:#E07A3F; animation:spin 1s linear infinite; }  @keyframes spin { to { transform: rotate(360deg); } }  .file-placeholder { display:grid; place-items:center; width:100%; height:100%;    font-size:.7rem; color:#555; background:#f3f4f6; }</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css"><script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script><div class="max-w-3xl mx-auto w-full px-4 py-6">  <h1 class="text-2xl font-bold mb-4">Edit Prompt</h1>  <form id="editPromptForm" action="/admin_update_prompt/{{ prompt.id }}" method="post" enctype="multipart/form-data" class="bg-white/50 backdrop-blur rounded-xl p-4 shadow">    <input type="hidden" id="editPromptId" name="prompt_id" value="{{ prompt.id }}">    <label class="block text-sm font-medium">Prompt text</label>    <textarea id="editPromptText" name="prompt_text" rows="4"      class="w-full border rounded p-2 mb-3">{{ prompt.text }}</textarea>    <label class="block text-sm font-medium">Chapter</label>    <input id="editChapter" name="chapter" value="{{ prompt.chapter or '' }}"      class="w-full border rounded p-2 mb-3" />    <label class="block text-sm font-medium">Tags</label>    <input id="editTags" name="tags" class="w-full border rounded p-2 mb-3" placeholder="Add tagsâ€¦" />{% set total = (assigned_users|length) if assigned_users is defined else 0 %}{% set answered = (assigned_users|selectattr('answered')|list|length) if assigned_users is defined else 0 %}<div class="border-t border-stone-200 pt-3">  <div class="flex items-center justify-between mb-1">    <div class="text-sm font-medium">      Assigned users      <span class="text-xs text-stone-600">(<span id="assignCount">{{ total }}</span> total, <span id="assignAnswered">{{ answered }}</span> answered)</span>    </div>  </div>  <div id="assignChips"       class="flex flex-wrap gap-2 mb-2"       data-prompt-id="{{ prompt.id }}"       data-hydrated="{{ 'true' if total else 'false' }}">    {% for u in (assigned_users or []) %}      <span class="chip chip-orange chip-assign inline-flex items-center gap-1 px-2 py-0.5 rounded-full shadow-sm {% if u.answered %}ring-1 ring-green-500{% endif %}"            data-user-id="{{ u.id }}"            data-answered="{{ '1' if u.answered else '0' }}">        <span class="truncate max-w-[12rem]">{{ u.name or u.email }}</span>        {% if u.answered %}          <span class="material-symbols-outlined text-[16px]" title="Answered">check_circle</span>        {% endif %}        <button type="button" class="chip-x text-[14px] leading-none" aria-label="Remove">Ã—</button>      </span>    {% endfor %}  </div>  <div class="relative">    <input id="assignInput" type="text" class="border rounded px-2 py-1 w-full text-sm"           placeholder="Add user by name or emailâ€¦" autocomplete="off">    <div id="assignDD" class="absolute z-10 bg-white border border-stone-200 rounded shadow hidden mt-1 w-full max-h-56 overflow-auto" role="listbox"></div>  </div>  <p class="text-xs text-gray-500 mt-1">Click Ã— to remove. Green-ring chips have answered.</p></div><div class="border-t border-stone-200 pt-3">  <div class="text-sm font-medium mb-1">Media</div>  <!-- Current media (single source of truth) -->  <div id="mediaGrid" class="flex gap-2 flex-wrap">    {% for m in (media_list or []) %}      <div class="relative group w-16 h-16 rounded border overflow-hidden bg-white" data-media-card="{{ m.id }}">        <img src="{{ m.thumbnail_url or m.file_url }}" class="w-full h-full object-cover" alt="">        <button type="button" title="Remove"                class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 grid place-items-center"                data-action="delete" data-media-id="{{ m.id }}">Ã—</button>      </div>    {% endfor %}  </div>  <!-- Dropzone upload form (AJAX) -->  <div id="promptMediaForm"        action="/admin/prompts/{{ prompt.id }}/media"        method="post" enctype="multipart/form-data"        class="mt-3">    <input id="promptFiles" name="media_files" type="file" multiple accept="image/*,video/*,audio/*" class="hidden">    <div id="promptDrop"         class="rounded border border-dashed border-stone-300 bg-white/60 p-4 text-sm text-stone-600 cursor-pointer">      <div class="flex items-center gap-2">        <span class="material-symbols-outlined">upload_file</span>        <span>Drop files here or click to upload</span>      </div>    </div>  </div></div>    <div class="flex justify-end gap-2 pt-2">      <a href="/admin_dashboard" class="px-4 py-2 border rounded">Cancel</a>      <button type="submit" class="px-4 py-2 rounded text-white" style="background: {{ ORANGE }};">Update</button>    </div>    <p id="editMsg" class="text-sm mt-3"></p>  </form></div><script>  /* Tagify for edit */  (function initTagify(){    const el = document.getElementById('editTags');    if (!el) return;    // If a previous modal left an instance around, clean it up    try { window.editTagify?.destroy?.(); } catch (_) {}    const t = new Tagify(el, {      maxTags: 25,      trim: true,      duplicates: false,      delimiters: ",",      dropdown: { enabled: 0, maxItems: 12, highlightFirst: true },      originalInputValueFormat: values => JSON.stringify(values.map(v => v.value))    });    window.editTagify = t; // expose for the saver code    // seed tags from the server    try {      const seed = {{ (tag_list or []) | tojson | safe }};      if (Array.isArray(seed) && seed.length) t.addTags(seed.map(x => x.name));    } catch {}    // async suggestions    let ctl;    t.on('input', async e => {      const v = (e.detail.value || '').trim();      if (!v) return;      try {        ctl?.abort();        ctl = new AbortController();        const r = await fetch(`/admin/tags?q=${encodeURIComponent(v)}`, {          credentials: 'include',          signal: ctl.signal        });        if (!r.ok) return;        const list = await r.json();        t.settings.whitelist = (list || []).map(x => ({ value: x.name, slug: x.slug }));        t.dropdown.show.call(t, v);      } catch {}    });  })();    (function(){      const pid   = {{ prompt.id }};      const chips = document.getElementById('assignChips');      const input = document.getElementById('assignInput');      const dd    = document.getElementById('assignDD');      const elCount = document.getElementById('assignCount');      const elAns   = document.getElementById('assignAnswered');      function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }      function recalcCounts(){        const total = chips.querySelectorAll('.chip-assign').length;        const answered = chips.querySelectorAll('.chip-assign[data-answered="1"]').length;        if (elCount) elCount.textContent = total;        if (elAns)   elAns.textContent = answered;      }      function mkChip(label, uid, answered){        const span = document.createElement('span');        span.className = 'chip chip-orange chip-assign inline-flex items-center gap-1 px-2 py-0.5 rounded-full shadow-sm' + (answered ? ' ring-1 ring-green-500' : '');        span.setAttribute('data-user-id', uid);        span.setAttribute('data-answered', answered ? '1' : '0');        span.innerHTML = `          <span class="truncate max-w-[12rem]">${escapeHTML(label)}</span>          ${answered ? '<span class="material-symbols-outlined text-[16px]" title="Answered">check_circle</span>' : ''}          <button type="button" class="chip-x text-[14px] leading-none" aria-label="Remove">Ã—</button>`;        return span;      }      async function hydrate(){        if (chips.dataset.hydrated === 'true') { bindChipRemovers(); return; }        try{          const r = await fetch(`/api/admin/assignments/by-prompt?prompt_id=${encodeURIComponent(pid)}`, { credentials:'include' });          if (!r.ok) return;          const data = await r.json();          chips.innerHTML = '';          (data.users || []).forEach(u => chips.appendChild(mkChip(u.name || u.email, u.id, !!u.answered)));          chips.dataset.hydrated = 'true';          bindChipRemovers();          recalcCounts();        }catch{}      }      function bindChipRemovers(){        chips.querySelectorAll('.chip-assign .chip-x').forEach(btn=>{          if (btn.__bound) return; btn.__bound = true;          btn.addEventListener('click', async ()=>{            const uid = btn.closest('[data-user-id]')?.getAttribute('data-user-id');            if (!uid) return;            const r = await fetch('/api/admin/pool/remove', {              method:'POST', credentials:'include',              headers:{'Content-Type':'application/json'},              body: JSON.stringify({ prompt_id: Number(pid), user_id: Number(uid) })            });            if (r.ok){ btn.closest('.chip-assign')?.remove(); recalcCounts(); }          });        });      }      async function searchUsers(q){        const r = await fetch(`/admin/users/search?q=${encodeURIComponent(q)}`, { credentials:'include' });        if (!r.ok) return [];        const payload = await r.json();        return Array.isArray(payload) ? payload : (payload.users || []);      }      function hideDD(){ dd.classList.add('hidden'); dd.innerHTML=''; }      let ctl;      input.addEventListener('input', async ()=>{        const q = input.value.trim();        if (q.length < 2){ hideDD(); return; }        try{          ctl?.abort(); ctl = new AbortController();          const users = await searchUsers(q);          dd.innerHTML = users.length            ? users.map(u => `<button type="button" role="option" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100"                                data-id="${u.id}" data-label="${escapeHTML(u.name || u.email)}">                                <div class="font-medium">${escapeHTML(u.name || u.email)}</div>                                <div class="text-xs text-stone-600">${escapeHTML(u.email || '')}</div>                              </button>`).join('')            : `<div class="px-3 py-2 text-sm text-gray-500">No matches</div>`;          dd.classList.remove('hidden');        }catch{}      });      dd.addEventListener('click', async (e)=>{        const b = e.target.closest('button[data-id]'); if (!b) return;        const uid = b.getAttribute('data-id');        const label = b.getAttribute('data-label') || '';        if (chips.querySelector(`[data-user-id="${CSS.escape(uid)}"]`)) { input.value=''; hideDD(); return; }        const r = await fetch('/api/admin/pool/add', {          method:'POST', credentials:'include',          headers:{'Content-Type':'application/json'},          body: JSON.stringify({ prompt_id: Number(pid), user_id: Number(uid) })        });        if (r.ok){          chips.appendChild(mkChip(label, uid, /*answered=*/false));          bindChipRemovers();          recalcCounts();          input.value=''; hideDD();        }      });      document.addEventListener('click', (ev)=>{ if (!dd.contains(ev.target) && ev.target!==input) hideDD(); });      // go!      hydrate();    })();</script><script>(function(){  const ORANGE = '#E07A3F';  // ---- tiny utils ----  const byId = (id) => document.getElementById(id);  const toast = (m) => (window.toast ? window.toast(m) : console.log(m));  function resolveUploadUrl(){    const el = document.getElementById('promptMediaForm');    if (!el) return null;    // support either <form action="..."> or <div data-action="...">    return el.getAttribute('action') || el.dataset.action || null;  }  function currentGrid(){    // prefer #mediaGrid, fallback to #attachedMediaPreview if you kept both    return byId('mediaGrid') || byId('attachedMediaPreview');  }  function makeSpinner(){    const s = document.createElement('div');    s.className = 'spinner';    return s;  }  function filePlaceholder(ext){    const d = document.createElement('div');    d.className = 'file-placeholder';    d.textContent = (ext || 'FILE').toUpperCase();    return d;  }  function makePendingCard(file){    const card = document.createElement('div');    card.className = 'relative group w-16 h-16 rounded border overflow-hidden bg-white';    let imgEl = null;    if (file?.type?.startsWith('image/')) {      const url = URL.createObjectURL(file);      imgEl = document.createElement('img');      imgEl.src = url;      imgEl.className = 'w-full h-full object-cover';      card.appendChild(imgEl);      card.__revoke = () => URL.revokeObjectURL(url);    } else {      const ext = (file?.name || '').split('.').pop() || '';      card.appendChild(filePlaceholder(ext));    }    card.appendChild(makeSpinner());    (currentGrid() || document.body).appendChild(card);    card.__img = imgEl;    return card;  }  function attachDeleteBtn(card, mediaId){    card.querySelector('[data-action="delete"]')?.remove();    const b = document.createElement('button');    b.type = 'button';    b.title = 'Remove';    b.className = 'absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 grid place-items-center';    b.setAttribute('data-action','delete');    b.setAttribute('data-media-id', String(mediaId));    b.textContent = 'Ã—';    card.appendChild(b);  }  function whenImageLoads(url, ok, fail){    const test = new Image();    const bust = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();    test.onload  = () => ok(bust);    test.onerror = fail;    test.src = bust;  }  function pollForThumb(card, url){    if (!url) { card.querySelector('.spinner')?.remove(); return; }    let tries = 0, max = 12, delay = 1200;    (function tick(){      whenImageLoads(url, (fresh)=>{        if (!card.__img) {          card.innerHTML = '';          const img = document.createElement('img');          img.className = 'w-full h-full object-cover';          img.src = fresh;          card.appendChild(img);          card.__img = img;        } else {          card.__img.src = fresh;        }        card.querySelector('.spinner')?.remove();      }, ()=>{        if (++tries < max) setTimeout(tick, delay);        else card.querySelector('.spinner')?.remove();      });    })();  }  async function uploadFiles(files){    if (!files || !files.length) return;    // resolve DOM pieces at the moment of use    const uploadUrl = resolveUploadUrl();    if (!uploadUrl) { toast('Upload form not ready'); return; }    const pendingCards = Array.from(files).map(makePendingCard);    const fd = new FormData();    for (const f of files) fd.append('media_files', f);    try{      const r = await fetch(uploadUrl, { method:'POST', body: fd, credentials:'include' });      if (!r.ok) throw new Error('Upload failed');      const payload = await r.json();      const items = (payload && payload.media) || [];      items.forEach((it, i) => {        const card = pendingCards[i]; if (!card) return;        if (typeof card.__revoke === 'function') card.__revoke();        card.setAttribute('data-media-card', String(it.id));        attachDeleteBtn(card, it.id);        const initial = it.thumbnail_url || it.file_url || '';        if (initial && card.__img) {          card.__img.src = initial + (initial.includes('?')?'&':'?') + 'v=' + Date.now();        }        pollForThumb(card, it.thumbnail_url || it.file_url);      });      toast('Uploaded');    } catch (err){      console.error(err);      toast('Upload failed');      pendingCards.forEach((card)=>{ card.style.boxShadow='inset 0 0 0 2px #dc2626'; card.querySelector('.spinner')?.remove(); });    } finally {      const fi = byId('promptFiles');      if (fi) fi.value = '';    }  }  // ---------- Events (resolve elements on demand) ----------  document.addEventListener('click', (e)=>{    const dz = byId('promptDrop');    if (dz && (e.target === dz || dz.contains(e.target)) && e.type === 'click') {      byId('promptFiles')?.click();    }  });  const dz = byId('promptDrop');  dz?.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.style.borderColor = ORANGE; dz.style.background = '#FFF4EF'; });  dz?.addEventListener('dragleave', ()=>{ dz.style.borderColor = ''; dz.style.background = ''; });  dz?.addEventListener('drop', (e)=>{    e.preventDefault();    dz.style.borderColor = ''; dz.style.background = '';    uploadFiles(e.dataTransfer.files);  });  byId('promptFiles')?.addEventListener('change', (e)=>{    uploadFiles(e.target.files);    e.target.value = '';  });  // delegated delete (works across grids)  document.addEventListener('click', async (e)=>{    const btn = e.target.closest('[data-action="delete"][data-media-id]');    if (!btn) return;    const mid = btn.getAttribute('data-media-id'); if (!mid) return;    if (!confirm('Remove this media?')) return;    try{      const r = await fetch(`/admin_delete_prompt_media/${encodeURIComponent(mid)}`, { method:'DELETE', credentials:'include' });      if (r.ok) { btn.closest('[data-media-card]')?.remove(); toast('Removed'); }      else toast('Failed to remove');    } catch { toast('Failed to remove'); }  });})();</script>{% endblock %}