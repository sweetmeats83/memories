{# Only extend base when it's a full page #}{% if not partial %}{% extends "base.html" %}{% endif %}{% block content %}{# move your constants INSIDE the block so "extends" stays first #}{% set ORANGE = "#C65D31" %}{% set ORANGE_HOVER = "#E07A3F" %}{% set BORDER = "#E7E5E4" %}<style>  .spinner { position:absolute; inset:0; display:grid; place-items:center; background:rgba(255,255,255,.6); }  .spinner::after { content:""; width:20px; height:20px; border-radius:50%;    border:3px solid #e5e7eb; border-top-color:#E07A3F; animation:spin 1s linear infinite; }  @keyframes spin { to { transform: rotate(360deg); } }  .file-placeholder { display:grid; place-items:center; width:100%; height:100%;    font-size:.7rem; color:#555; background:#f3f4f6; }</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css"><script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script><div class="max-w-3xl mx-auto w-full px-4 py-6">  <h1 class="text-2xl font-bold mb-4">Edit Prompt</h1>  <form id="editPromptForm" action="/admin_update_prompt/{{ prompt.id }}" method="post" enctype="multipart/form-data" class="bg-white/50 backdrop-blur rounded-xl p-4 shadow">    <input type="hidden" id="editPromptId" name="prompt_id" value="{{ prompt.id }}">    <label class="block text-sm font-medium">Prompt text</label>    <textarea id="editPromptText" name="prompt_text" rows="4"      class="w-full border rounded p-2 mb-3">{{ prompt.text }}</textarea>    <label class="block text-sm font-medium">Chapter</label>    <input id="editChapter" name="chapter" value="{{ prompt.chapter or '' }}"      class="w-full border rounded p-2 mb-3" />    <label class="block text-sm font-medium">Tags</label>    <input id="editTags" name="tags" class="w-full border rounded p-2 mb-3" placeholder="Add tags…" />{% set total = (assigned_users|length) if assigned_users is defined else 0 %}{% set answered = (assigned_users|selectattr('answered')|list|length) if assigned_users is defined else 0 %}<div class="border-t border-stone-200 pt-3">  <div class="flex items-center justify-between mb-1">    <div class="text-sm font-medium">      Assigned users      <span class="text-xs text-stone-600">(<span id="assignCount">{{ total }}</span> total, <span id="assignAnswered">{{ answered }}</span> answered)</span>    </div>  </div>  <div id="assignChips"       class="flex flex-wrap gap-2 mb-2"       data-prompt-id="{{ prompt.id }}"       data-hydrated="{{ 'true' if total else 'false' }}">    {% for u in (assigned_users or []) %}      <span class="chip chip-orange chip-assign inline-flex items-center gap-1 px-2 py-0.5 rounded-full shadow-sm {% if u.answered %}ring-1 ring-green-500{% endif %}"            data-user-id="{{ u.id }}"            data-answered="{{ '1' if u.answered else '0' }}">        <span class="truncate max-w-[12rem]">{{ u.name or u.email }}</span>        {% if u.answered %}          <span class="material-symbols-outlined text-[16px]" title="Answered">check_circle</span>        {% endif %}        <button type="button" class="chip-x text-[14px] leading-none" aria-label="Remove">×</button>      </span>    {% endfor %}  </div>  <div class="relative">    <input id="assignInput" type="text" class="border rounded px-2 py-1 w-full text-sm"           placeholder="Add user by name or email…" autocomplete="off">    <div id="assignDD" class="absolute z-10 bg-white border border-stone-200 rounded shadow hidden mt-1 w-full max-h-56 overflow-auto" role="listbox"></div>  </div>  <p class="text-xs text-gray-500 mt-1">Click × to remove. Green-ring chips have answered.</p></div><div class="border-t border-stone-200 pt-3">  <div class="text-sm font-medium mb-1">Media</div>  <!-- Current media (single source of truth) -->  <div id="mediaGrid" class="flex gap-3 flex-wrap">    {% for m in (media_list or []) %}      <div class="relative group w-48 rounded border overflow-hidden bg-white" data-media-card="{{ m.id }}" data-assignees='{{ (m.assignees or []) | tojson | safe }}'>        <img src="{{ m.thumbnail_url or m.file_url }}" class="w-full h-28 object-cover" alt="">        <button type="button" title="Remove"                class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 grid place-items-center"                data-action="delete" data-media-id="{{ m.id }}">×</button>      </div>    {% endfor %}  </div>  <!-- Dropzone upload form (AJAX) -->  <div id="promptMediaForm"        action="/admin/prompts/{{ prompt.id }}/media"        method="post" enctype="multipart/form-data"        class="mt-3">    <input id="promptFiles" name="media_files" type="file" multiple accept="image/*,video/*,audio/*" class="hidden">    <div id="promptDrop"         class="rounded border border-dashed border-stone-300 bg-white/60 p-4 text-sm text-stone-600 cursor-pointer">      <div class="flex items-center gap-2">        <span class="material-symbols-outlined">upload_file</span>        <span>Drop files here or click to upload</span>      </div>    </div>  </div></div>    <div class="flex justify-end gap-2 pt-2">      <a href="/admin_dashboard" class="px-4 py-2 border rounded">Cancel</a>      <button type="submit" class="px-4 py-2 rounded text-white" style="background: {{ ORANGE }};">Update</button>    </div>    <p id="editMsg" class="text-sm mt-3"></p>  </form></div><script>  /* Tagify for edit */  (function initTagify(){    const el = document.getElementById('editTags');    if (!el) return;    // If a previous modal left an instance around, clean it up    try { window.editTagify?.destroy?.(); } catch (_) {}    const t = new Tagify(el, {      maxTags: 25,      trim: true,      duplicates: false,      delimiters: ",",      dropdown: { enabled: 0, maxItems: 12, highlightFirst: true },      originalInputValueFormat: values => JSON.stringify(values.map(v => v.value))    });    window.editTagify = t; // expose for the saver code    // seed tags from the server    try {      const seed = {{ (tag_list or []) | tojson | safe }};      if (Array.isArray(seed) && seed.length) t.addTags(seed.map(x => x.name));    } catch {}    // async suggestions    let ctl;    t.on('input', async e => {      const v = (e.detail.value || '').trim();      if (!v) return;      try {        ctl?.abort();        ctl = new AbortController();        const r = await fetch(`/admin/tags?q=${encodeURIComponent(v)}`, {          credentials: 'include',          signal: ctl.signal        });        if (!r.ok) return;        const list = await r.json();        t.settings.whitelist = (list || []).map(x => ({ value: x.name, slug: x.slug }));        t.dropdown.show.call(t, v);      } catch {}    });  })();    (function(){      const pid   = {{ prompt.id }};      const chips = document.getElementById('assignChips');      const input = document.getElementById('assignInput');      const dd    = document.getElementById('assignDD');      const elCount = document.getElementById('assignCount');      const elAns   = document.getElementById('assignAnswered');      function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }      function recalcCounts(){        const total = chips.querySelectorAll('.chip-assign').length;        const answered = chips.querySelectorAll('.chip-assign[data-answered="1"]').length;        if (elCount) elCount.textContent = total;        if (elAns)   elAns.textContent = answered;      }      function mkChip(label, uid, answered){        const span = document.createElement('span');        span.className = 'chip chip-orange chip-assign inline-flex items-center gap-1 px-2 py-0.5 rounded-full shadow-sm' + (answered ? ' ring-1 ring-green-500' : '');        span.setAttribute('data-user-id', uid);        span.setAttribute('data-answered', answered ? '1' : '0');        span.innerHTML = `          <span class="truncate max-w-[12rem]">${escapeHTML(label)}</span>          ${answered ? '<span class="material-symbols-outlined text-[16px]" title="Answered">check_circle</span>' : ''}          <button type="button" class="chip-x text-[14px] leading-none" aria-label="Remove">×</button>`;        return span;      }      async function hydrate(){        if (chips.dataset.hydrated === 'true') { bindChipRemovers(); return; }        try{          const r = await fetch(`/api/admin/assignments/by-prompt?prompt_id=${encodeURIComponent(pid)}`, { credentials:'include' });          if (!r.ok) return;          const data = await r.json();          chips.innerHTML = '';          (data.users || []).forEach(u => chips.appendChild(mkChip(u.name || u.email, u.id, !!u.answered)));          chips.dataset.hydrated = 'true';          bindChipRemovers();          recalcCounts();        }catch{}      }      function bindChipRemovers(){        chips.querySelectorAll('.chip-assign .chip-x').forEach(btn=>{          if (btn.__bound) return; btn.__bound = true;          btn.addEventListener('click', async ()=>{            const uid = btn.closest('[data-user-id]')?.getAttribute('data-user-id');            if (!uid) return;            const r = await fetch('/api/admin/pool/remove', {              method:'POST', credentials:'include',              headers:{'Content-Type':'application/json'},              body: JSON.stringify({ prompt_id: Number(pid), user_id: Number(uid) })            });            if (r.ok){ btn.closest('.chip-assign')?.remove(); recalcCounts(); }          });        });      }      async function searchUsers(q){        const r = await fetch(`/admin/users/search?q=${encodeURIComponent(q)}`, { credentials:'include' });        if (!r.ok) return [];        const payload = await r.json();        return Array.isArray(payload) ? payload : (payload.users || []);      }      function hideDD(){ dd.classList.add('hidden'); dd.innerHTML=''; }      let ctl;      input.addEventListener('input', async ()=>{        const q = input.value.trim();        if (q.length < 2){ hideDD(); return; }        try{          ctl?.abort(); ctl = new AbortController();          const users = await searchUsers(q);          dd.innerHTML = users.length            ? users.map(u => `<button type="button" role="option" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100"                                data-id="${u.id}" data-label="${escapeHTML(u.name || u.email)}">                                <div class="font-medium">${escapeHTML(u.name || u.email)}</div>                                <div class="text-xs text-stone-600">${escapeHTML(u.email || '')}</div>                              </button>`).join('')            : `<div class="px-3 py-2 text-sm text-gray-500">No matches</div>`;          dd.classList.remove('hidden');        }catch{}      });      dd.addEventListener('click', async (e)=>{        const b = e.target.closest('button[data-id]'); if (!b) return;        const uid = b.getAttribute('data-id');        const label = b.getAttribute('data-label') || '';        if (chips.querySelector(`[data-user-id="${CSS.escape(uid)}"]`)) { input.value=''; hideDD(); return; }        const r = await fetch('/api/admin/pool/add', {          method:'POST', credentials:'include',          headers:{'Content-Type':'application/json'},          body: JSON.stringify({ prompt_id: Number(pid), user_id: Number(uid) })        });        if (r.ok){          chips.appendChild(mkChip(label, uid, /*answered=*/false));          bindChipRemovers();          recalcCounts();          input.value=''; hideDD();        }      });      document.addEventListener('click', (ev)=>{ if (!dd.contains(ev.target) && ev.target!==input) hideDD(); });      // go!      hydrate();    })();</script><script>// Initialize Tagify per-media assignees below thumbnails(function(){  function toTag(u){ return { value: (u.name||u.email||''), uid: Number(u.id), email: u.email||'' }; }  async function searchUsers(q){    const r = await fetch(`/admin/users/search?q=${encodeURIComponent(q)}`, { credentials:'include' });    if (!r.ok) return [];    const payload = await r.json();    const list = Array.isArray(payload) ? payload : (payload.users || []);    return list.map(u => ({ value: (u.name||u.email), uid: u.id, email: u.email }));  }  document.querySelectorAll('.media-assign-input').forEach((input)=>{    if (input.__tagified) return; input.__tagified = true;    const card = input.closest('[data-media-card]');    const mediaId = input.getAttribute('data-media-id');    if (!card || !mediaId) return;    const raw = card.getAttribute('data-assignees') || '[]';    let seed = [];    try { seed = JSON.parse(raw) || []; } catch {}    const tagify = new Tagify(input, {      enforceWhitelist: true,      whitelist: [],      dropdown: { enabled: 0, maxItems: 10 },      originalInputValueFormat: (vals) => JSON.stringify(vals.map(v => ({ id: v.uid, label: v.value })))    });    // Seed existing    if (seed && seed.length) tagify.addTags(seed.map(toTag));    let ctl;    tagify.on('input', async (e)=>{      const v = (e.detail.value||'').trim();      if (v.length < 2) return tagify.dropdown.hide();      try{        ctl?.abort(); ctl = new AbortController();        const items = await searchUsers(v);        tagify.settings.whitelist = items;        tagify.dropdown.show(v);      }catch{}    });    tagify.on('add', async (e)=>{      const d = e.detail?.data || {};      if (typeof d.uid === 'undefined'){ return; }      try{        const r = await fetch(`/admin/prompt_media/${encodeURIComponent(mediaId)}/assignees/add`, {          method:'POST', credentials:'include', headers:{'Content-Type':'application/json'},          body: JSON.stringify({ user_id: Number(d.uid) })        });        if (!r.ok) throw new Error('add failed');      }catch(err){ tagify.removeTags(d.value); }    });    tagify.on('remove', async (e)=>{      const d = e.detail?.data || {};      if (typeof d.uid === 'undefined'){ return; }      try{        const r = await fetch(`/admin/prompt_media/${encodeURIComponent(mediaId)}/assignees/remove`, {          method:'POST', credentials:'include', headers:{'Content-Type':'application/json'},          body: JSON.stringify({ user_id: Number(d.uid) })        });        if (!r.ok) throw new Error('remove failed');      }catch(err){ /* silently ignore */ }    });  });})();</script><script>(function(){  const ORANGE = '#E07A3F';  // ---- tiny utils ----  const byId = (id) => document.getElementById(id);  const toast = (m) => (window.toast ? window.toast(m) : console.log(m));  function resolveUploadUrl(){    const el = document.getElementById('promptMediaForm');    if (!el) return null;    // support either <form action="..."> or <div data-action="...">    return el.getAttribute('action') || el.dataset.action || null;  }  function currentGrid(){    // prefer #mediaGrid, fallback to #attachedMediaPreview if you kept both    return byId('mediaGrid') || byId('attachedMediaPreview');  }  function makeSpinner(){    const s = document.createElement('div');    s.className = 'spinner';    return s;  }  function filePlaceholder(ext){    const d = document.createElement('div');    d.className = 'file-placeholder';    d.textContent = (ext || 'FILE').toUpperCase();    return d;  }  function makePendingCard(file){    const card = document.createElement('div');    card.className = 'relative group w-48 rounded border overflow-hidden bg-white';    let imgEl = null;    if (file?.type?.startsWith('image/')) {      const url = URL.createObjectURL(file);      imgEl = document.createElement('img');      imgEl.src = url;      imgEl.className = 'w-full h-full object-cover';      card.appendChild(imgEl);      card.__revoke = () => URL.revokeObjectURL(url);    } else {      const ext = (file?.name || '').split('.').pop() || '';      card.appendChild(filePlaceholder(ext));    }    card.appendChild(makeSpinner());    (currentGrid() || document.body).appendChild(card);    card.__img = imgEl;    return card;  }  function attachDeleteBtn(card, mediaId){    card.querySelector('[data-action="delete"]')?.remove();    const b = document.createElement('button');    b.type = 'button';    b.title = 'Remove';    b.className = 'absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 grid place-items-center';    b.setAttribute('data-action','delete');    b.setAttribute('data-media-id', String(mediaId));    b.textContent = '×';    card.appendChild(b);  }  function whenImageLoads(url, ok, fail){    const test = new Image();    const bust = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();    test.onload  = () => ok(bust);    test.onerror = fail;    test.src = bust;  }  function pollForThumb(card, url){    if (!url) { card.querySelector('.spinner')?.remove(); return; }    let tries = 0, max = 12, delay = 1200;    (function tick(){      whenImageLoads(url, (fresh)=>{        if (!card.__img) {          card.innerHTML = '';          const img = document.createElement('img');          img.className = 'w-full h-full object-cover';          img.src = fresh;          card.appendChild(img);          card.__img = img;        } else {          card.__img.src = fresh;        }        card.querySelector('.spinner')?.remove();      }, ()=>{        if (++tries < max) setTimeout(tick, delay);        else card.querySelector('.spinner')?.remove();      });    })();  }  async function uploadFiles(files){    if (!files || !files.length) return;    // resolve DOM pieces at the moment of use    const uploadUrl = resolveUploadUrl();    if (!uploadUrl) { toast('Upload form not ready'); return; }    const pendingCards = Array.from(files).map(makePendingCard);    const fd = new FormData();    for (const f of files) fd.append('media_files', f);    try{      const r = await fetch(uploadUrl, { method:'POST', body: fd, credentials:'include' });      if (!r.ok) throw new Error('Upload failed');      const payload = await r.json();      const items = (payload && payload.media) || [];      items.forEach((it, i) => {        const card = pendingCards[i]; if (!card) return;        if (typeof card.__revoke === 'function') card.__revoke();        card.setAttribute('data-media-card', String(it.id));        attachDeleteBtn(card, it.id);        const initial = it.thumbnail_url || it.file_url || '';        if (initial && card.__img) {          card.__img.src = initial + (initial.includes('?')?'&':'?') + 'v=' + Date.now();        }        pollForThumb(card, it.thumbnail_url || it.file_url);      });      toast('Uploaded');    } catch (err){      console.error(err);      toast('Upload failed');      pendingCards.forEach((card)=>{ card.style.boxShadow='inset 0 0 0 2px #dc2626'; card.querySelector('.spinner')?.remove(); });    } finally {      const fi = byId('promptFiles');      if (fi) fi.value = '';    }  }  // ---------- Events (resolve elements on demand) ----------  document.addEventListener('click', (e)=>{    const dz = byId('promptDrop');    if (dz && (e.target === dz || dz.contains(e.target)) && e.type === 'click') {      byId('promptFiles')?.click();    }  });  const dz = byId('promptDrop');  dz?.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.style.borderColor = ORANGE; dz.style.background = '#FFF4EF'; });  dz?.addEventListener('dragleave', ()=>{ dz.style.borderColor = ''; dz.style.background = ''; });  dz?.addEventListener('drop', (e)=>{    e.preventDefault();    dz.style.borderColor = ''; dz.style.background = '';    uploadFiles(e.dataTransfer.files);  });  byId('promptFiles')?.addEventListener('change', (e)=>{    uploadFiles(e.target.files);    e.target.value = '';  });  // delegated delete (works across grids)  document.addEventListener('click', async (e)=>{    const btn = e.target.closest('[data-action="delete"][data-media-id]');    if (!btn) return;    const mid = btn.getAttribute('data-media-id'); if (!mid) return;    if (!confirm('Remove this media?')) return;    try{      const r = await fetch(`/admin_delete_prompt_media/${encodeURIComponent(mid)}`, { method:'DELETE', credentials:'include' });      if (r.ok) { btn.closest('[data-media-card]')?.remove(); toast('Removed'); }      else toast('Failed to remove');    } catch { toast('Failed to remove'); }  });  // -------- Per-media assignee UI (dynamic; uses existing admin APIs) --------  (async function initMediaAssignees(){    const pidEl = document.getElementById('editPromptId');    const pid = pidEl && Number(pidEl.value);    if (!pid) return;    try{      const r = await fetch(`/api/admin/prompt/${encodeURIComponent(pid)}/media`, { credentials:'include' });      if (!r.ok) return; const payload = await r.json();      const media = (payload && payload.media) || [];      media.forEach(m => {        const card = document.querySelector(`[data-media-card="${CSS.escape(String(m.id))}"]`);        if (!card) return;        if (card.querySelector('[data-media-assignments],[data-media-assign-field]')) return; // already rendered by server        // build container        const box = document.createElement('div');        box.className = 'p-2 text-[11px] space-y-1';        box.setAttribute('data-media-assignments','');        box.innerHTML = `          <div class="flex items-center justify-between">            <span class="text-stone-600">Assignees</span>            <button type="button" class="px-2 py-0.5 rounded border text-[11px]" data-action="media-assign-open" data-media-id="${m.id}">Add</button>          </div>          <div class="flex flex-wrap gap-1" data-media-assignee-chips></div>`;        const chips = box.querySelector('[data-media-assignee-chips]');        (m.assignees||[]).forEach(u => {          const span = document.createElement('span');          span.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-stone-100 border text-[11px]';          span.setAttribute('data-user-id', String(u.id));          const safe = String(u.name||u.email||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');          span.innerHTML = `<span class="truncate max-w-[7rem]">${safe}</span>`;          const x = document.createElement('button');          x.type = 'button'; x.title='Remove'; x.className='text-stone-600 hover:text-red-600'; x.textContent='×';          x.setAttribute('data-action','media-assign-remove'); x.setAttribute('data-media-id', String(m.id)); x.setAttribute('data-user-id', String(u.id));          span.appendChild(x);          chips.appendChild(span);        });        // popover        const pop = document.createElement('div');        pop.className = 'absolute z-20 hidden bg-white border rounded shadow w-56 p-2 text-[12px]';        pop.setAttribute('data-media-assign-popover','');        pop.setAttribute('data-media-id', String(m.id));        pop.style.right = '4px'; pop.style.top = '28px';        pop.innerHTML = `<input type="text" placeholder="Search users…" class="w-full border rounded px-2 py-1 mb-1" data-media-assign-input>                         <div class="max-h-40 overflow-auto border rounded" data-media-assign-results></div>`;        // Render the assignee chips BELOW the thumbnail so it’s visible        box.classList.add('mt-1');        card.insertAdjacentElement('afterend', box);        // Keep the popover anchored to the card (absolute positioning)        card.appendChild(pop);      });    } catch {}    async function searchUsers(q){      const r = await fetch(`/admin/users/search?q=${encodeURIComponent(q)}`, { credentials:'include' });      if (!r.ok) return []; const payload = await r.json();      return Array.isArray(payload) ? payload : (payload.users || []);    }    async function addAssignee(mid, uid){      const r = await fetch(`/admin/prompt_media/${encodeURIComponent(mid)}/assignees/add`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: Number(uid) }) });      return r.ok;    }    async function removeAssignee(mid, uid){      const r = await fetch(`/admin/prompt_media/${encodeURIComponent(mid)}/assignees/remove`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: Number(uid) }) });      return r.ok;    }    // open popover    document.addEventListener('click', (e)=>{      const b = e.target.closest('[data-action="media-assign-open"][data-media-id]');      if (!b) return;      const card = b.closest('[data-media-card]');      const pop = card?.querySelector('[data-media-assign-popover]');      const input = pop?.querySelector('[data-media-assign-input]');      const list  = pop?.querySelector('[data-media-assign-results]');      if (!pop || !input || !list) return;      const showing = !pop.classList.contains('hidden');      document.querySelectorAll('[data-media-assign-popover]').forEach(x=>x.classList.add('hidden'));      if (showing) return;      pop.classList.remove('hidden'); input.value=''; list.innerHTML=''; input.focus();    });    // type to search    document.addEventListener('input', async (e)=>{      const el = e.target.closest('[data-media-assign-input]');      if (!el) return;      const pop = el.closest('[data-media-assign-popover]');      const list = pop?.querySelector('[data-media-assign-results]');      const q = el.value.trim(); if (!list) return; if (q.length < 2){ list.innerHTML=''; return; }      try{        const users = await searchUsers(q);        list.innerHTML = users.length          ? users.map(u => `<button type="button" class="w-full text-left px-2 py-1 hover:bg-stone-100" data-action="media-assign-pick" data-user-id="${u.id}" data-label="${(u.name||u.email||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}">${(u.name||u.email||'')}</button>`).join('')          : `<div class="px-2 py-1 text-stone-500">No matches</div>`;      } catch { list.innerHTML = '<div class="px-2 py-1 text-stone-500">Error</div>'; }    });    // choose user    document.addEventListener('click', async (e)=>{      const b = e.target.closest('[data-action="media-assign-pick"][data-user-id]');      if (!b) return;      const pop = b.closest('[data-media-assign-popover]');      const mediaId = pop?.getAttribute('data-media-id');      const card = pop?.closest('[data-media-card]');      const chipBox = card?.querySelector('[data-media-assignee-chips]');      const uid = b.getAttribute('data-user-id');      const label = b.getAttribute('data-label') || '';      if (!mediaId || !uid || !chipBox) return;      const ok = await addAssignee(mediaId, uid);      if (ok){        if (!chipBox.querySelector(`[data-user-id="${CSS.escape(String(uid))}"]`)){          const safe = label;          const chip = document.createElement('span');          chip.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-stone-100 border text-[11px]';          chip.setAttribute('data-user-id', String(uid));          chip.innerHTML = `<span class="truncate max-w-[7rem]">${safe}</span>`;          const x = document.createElement('button'); x.type='button'; x.title='Remove'; x.className='text-stone-600 hover:text-red-600'; x.textContent='×';          x.setAttribute('data-action','media-assign-remove'); x.setAttribute('data-media-id', String(mediaId)); x.setAttribute('data-user-id', String(uid));          chip.appendChild(x); chipBox.appendChild(chip);        }        pop.classList.add('hidden');      }    });    // remove chip    document.addEventListener('click', async (e)=>{      const x = e.target.closest('[data-action="media-assign-remove"][data-media-id][data-user-id]');      if (!x) return;      const mediaId = x.getAttribute('data-media-id');      const uid = x.getAttribute('data-user-id');      const ok = await removeAssignee(mediaId, uid);      if (ok){ x.closest('[data-user-id]')?.remove(); }    });    // outside to close    document.addEventListener('click', (e)=>{      const any = e.target.closest('[data-media-assign-popover], [data-action="media-assign-open"]');      if (any) return;      document.querySelectorAll('[data-media-assign-popover]').forEach(x=>x.classList.add('hidden'));    });  })();})();</script>{% endblock %}